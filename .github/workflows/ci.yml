name: Monorepo React Library CI

# 触发条件：main分支有push/PR，所有PR都触发（和子包一致，可按需扩展）
on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

# 顶层配置：部署GitHub Pages所需权限（所有作业可复用，也可在部署作业内单独配置）
permissions:
  contents: write # 从read改为write，允许创建/推送分支
  pull-requests: write # 新增：允许创建/管理PR
  pages: write # 保留：部署GitHub Pages所需
  id-token: write # 保留：Pages部署的身份验证

# 作业配置
jobs:
  # 代码校验 & 构建作业（覆盖所有子包）
  validate-and-build:
    # 依赖：仅当release-please作业成功完成后，才执行该作业
    # needs: [release-please]
    runs-on: ubuntu-latest
    # 可选：指定Node版本矩阵，多版本测试（按需开启）
    # strategy:
    #   matrix:
    #     node-version: [20.x, 18.x]

    steps:
      # 1. 安装pnpm（Ubuntu默认无pnpm，需手动安装）
      - name: Install pnpm
        run: |
          corepack enable # 启用corepack（Node.js 16+内置，管理pnpm/yarn）
          corepack prepare pnpm@latest --activate # 安装最新版pnpm（可指定版本如pnpm@9.x）

      # 2. 检出代码（必须带fetch-depth: 0，否则pnpm workspace可能识别异常）
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 3. 设置Node.js环境（匹配项目Node版本，优先LTS）
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: 'pnpm' # 关键：改为pnpm缓存（替代原npm）
          cache-dependency-path: '**/pnpm-lock.yaml' # 指定pnpm锁文件路径

      # 4. 安装monorepo所有依赖（pnpm ci替代npm ci，更适配monorepo）
      - name: Install dependencies
        run: |
          pnpm install --frozen-lockfile # 严格按pnpm-lock.yaml安装，禁用版本更新
          pnpm list # 可选：打印依赖列表，方便调试

      # 5. Prettier格式校验（同理，支持根目录/指定子包）
      - name: Run Prettier check
        run: pnpm run format:check
        # 方式2：仅校验指定子包
        # run: pnpm --filter @event-chat/core format:check

      # 6. TypeScript类型检查（monorepo下推荐根目录执行tsc，或子包单独执行）
      - name: Run TypeScript type check
        # 方式1：根目录执行tsc（需根tsconfig.json配置"composite": true）
        run: pnpm tsc --noEmit
        # 方式2：仅检查指定子包
        # run: pnpm --filter @event-chat/core tsc --noEmit

      # 7. 执行构建（构建指定子包，或所有子包）
      - name: Build project
        # 方式1：构建指定子包（推荐，避免构建无关包）
        # run: pnpm --filter @event-chat/core build
        # 方式2：构建所有子包（根package.json配置"build": "pnpm -r build"）
        run: pnpm run build

      # 8. ESLint代码质量检查（执行根目录lint，或指定子包）
      - name: Run ESLint check
        # 方式1：执行根目录统一的lint脚本（推荐，需根package.json配置）
        run: pnpm run lint
        # 方式2：仅校验指定子包（如@event-chat/core）
        # run: pnpm --filter @event-chat/core lint

      # 9. 上传构建产物（适配monorepo子包的dist路径）
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: core-build-output
          path: packages/core/dist/ # 关键：改为子包的dist路径
          retention-days: 7

  # 更新 release
  release-please:
    needs: [validate-and-build]
    runs-on: ubuntu-latest
    outputs:
      # 输出每个子包的独立发布状态和Tag
      antd-item--release_created: ${{ steps.release.outputs['packages/antd-item--release_created'] }}
      antd-item--tag_name: ${{ steps.release.outputs['packages/antd-item--tag_name'] }}
      antd-item--version: ${{ steps.release.outputs['packages/antd-item--version'] }} # 新增：输出版本号
      core--release_created: ${{ steps.release.outputs['packages/core--release_created'] }}
      core--tag_name: ${{ steps.release.outputs['packages/core--tag_name'] }}
      core--version: ${{ steps.release.outputs['packages/core--version'] }}
      releases_created: ${{ steps.release.outputs.releases_created }}
    steps:
      - uses: googleapis/release-please-action@v4
        id: release
        with:
          token: ${{ secrets.GH_PACKAGES_TOKEN }}
          include-component-in-tag: true
          config-file: release-please-config.json
          manifest-file: .release-please-manifest.json
      - name: Print release outputs for debugging
        continue-on-error: true
        run: |
          echo "Release outputs (write to file first):"
          # 方案1：将JSON输出到文件，再cat查看（推荐，避免特殊字符解析）
          echo '${{ toJson(steps.release.outputs) }}' > release-outputs.json
          cat release-outputs.json

  # 调整：发布到 npm（仅发布有更新的子包）
  publish-to-npm:
    needs: [release-please, validate-and-build]
    runs-on: ubuntu-latest
    # 只要有任意子包发布，就触发该作业
    if: ${{ needs.release-please.outputs.releases_created == 'true' && github.event_name == 'push' && github.ref == 'refs/heads/main' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Install pnpm
        run: |
          corepack enable
          corepack prepare pnpm@latest --activate
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: 'pnpm'
          cache-dependency-path: '**/pnpm-lock.yaml'
          registry-url: https://registry.npmjs.org/
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      - name: Build packages
        run: pnpm run build

      # 仅发布antd-item（如果该包有更新）
      - name: Publish antd-item to npm
        if: ${{ needs.release-please.outputs['antd-item--release_created'] == 'true' }}
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: pnpm --filter @event-chat/antd-item publish --access public --no-git-checks

      # 仅发布core（如果该包有更新）
      - name: Publish core to npm
        if: ${{ needs.release-please.outputs['core--release_created'] == 'true' }}
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: pnpm --filter @event-chat/core publish --access public --no-git-checks

  # 调整：发布到 GitHub Packages（仅发布有更新的子包）
  publish-to-github-packages:
    needs: [release-please, validate-and-build]
    runs-on: ubuntu-latest
    if: ${{ needs.release-please.outputs.releases_created == 'true' && github.event_name == 'push' && github.ref == 'refs/heads/main' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Install pnpm
        run: |
          corepack enable
          corepack prepare pnpm@latest --activate
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: 'pnpm'
          cache-dependency-path: '**/pnpm-lock.yaml'
          registry-url: https://npm.pkg.github.com/
          scope: '@event-chat'
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      - name: Build packages
        run: pnpm run build

      # 仅发布antd-item（如果该包有更新）
      - name: Publish antd-item to GitHub Packages
        if: ${{ needs.release-please.outputs['antd-item--release_created'] == 'true' }}
        env:
          NODE_AUTH_TOKEN: ${{ secrets.GH_PACKAGES_TOKEN }}
        run: pnpm --filter @event-chat/antd-item publish --access public --no-git-checks

      # 仅发布core（如果该包有更新）
      - name: Publish core to GitHub Packages
        if: ${{ needs.release-please.outputs['core--release_created'] == 'true' }}
        env:
          NODE_AUTH_TOKEN: ${{ secrets.GH_PACKAGES_TOKEN }}
        run: pnpm --filter @event-chat/core publish --access public --no-git-checks

  # 新增：Storybook部署到GitHub Pages作业
  deploy-storybook:
    # 依赖：仅当validate-and-build作业成功完成后，才执行该作业
    needs: [validate-and-build]
    # 运行环境：与原有作业一致
    runs-on: ubuntu-latest
    # 触发筛选：仅在「main分支push」时执行（排除PR触发，避免冗余部署）
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      # 1. 检出代码（与原有作业一致，需fetch-depth: 0）
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2. 安装pnpm（与原有作业一致）
      - name: Install pnpm
        run: |
          corepack enable
          corepack prepare pnpm@latest --activate

      # 3. 设置Node.js环境（复用缓存，提升效率）
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: 'pnpm'
          cache-dependency-path: '**/pnpm-lock.yaml'

      # 4. 安装依赖（复用缓存，无需重新下载）
      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      # 4.1 其他操作同上
      - name: Run Prettier check
        run: pnpm run format:check

      - name: Run TypeScript type check
        run: pnpm tsc --noEmit

      - name: Build project
        run: pnpm run build

      # 5. 构建子包的Storybook
      - name: Build Storybook for subpackage
        run: pnpm --filter @event-chat/example run build-storybook

      # 6. 上传Storybook静态文件为Pages工件
      - name: Upload Storybook Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: 'packages/example/storybook-static'

      # 7. 部署到GitHub Pages（官方套件，无需额外指定目录）
      - id: deploy
        name: Deploy to GitHub Pages
        uses: actions/deploy-pages@v4
        with:
          token: ${{ github.token }}
